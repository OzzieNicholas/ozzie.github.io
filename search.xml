<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>细解浏览器缓存</title>
      <link href="6bbe4ee13dda/"/>
      <url>6bbe4ee13dda/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><ol><li><p>在开发中，我们总会提到 “合理设置缓存”，缓存机制非常普遍，有客户端缓存、服务器缓存、代理服务器缓存等等，在 HTTP 中，具有缓存功能的是浏览器缓存。 HTTP 缓存是作为web 性能优化的重要手段。</p></li><li><p>HTML5 引入了应用程序缓存，在没有网络的情况下也能进行访问，同时，还引入了 storage 本地存储，这些都属于应用缓存，本文主要是和浏览器缓存相关的，也可以说是 HTTP 缓存。</p></li><li><p>什么是浏览器缓存？</p><ul><li><p>MDN 的解释是：</p><blockquote><p>A browser cache holds all documents downloaded via HTTP by the user … without requiring an additional trip to the server.</p></blockquote><p>意思就是，浏览器缓存保存着用户通过 <code>HTTP</code> 获取的所有资源，再下一次请求时可以避免重复向服务器发出多余的请求，简单说，就是在你访问过某网站之后，这个站点的文字、图片等所有资源都被下载到本地了，下次再党文该网站时，会判断是否满足缓存条件，如果满足，则不用再花时间去等待资源的获取了。</p></li><li><p>浏览器的缓存机制也就是我们说的 HTTP 缓存机制，其机制是根据 HTTP 报文的缓存标识进行的所以在分析浏览器缓存机制之前，我们待会儿得先简单介绍一下 HTTP 报文。</p></li></ul></li></ol><hr><h2 id="HTTP-报文"><a href="#HTTP-报文" class="headerlink" title="HTTP 报文"></a>HTTP 报文</h2><ol><li><p>HTTP 报文分两种：</p><ul><li><p>HTTP 请求（Resquest）报文，报文格式为：请求行 — HTTP 头（通用信息头、请求头、实体头）— 请求报文主体（只有 POST 才有报文主体），如图：<br><img src="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAmTQvAXcAARn6lyQKXxoQbxkSWdcVicZoAvUxILHMgHLdO2RRo2qia39A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAmTQvAXcAARn6lyQKXxoQbxkSWdcVicZoAvUxILHMgHLdO2RRo2qia39A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAX9mOHmr8qBEmNDbpKg4quBwFxGcicbotsk5YMOSZrAhkXm9hMEl0TYg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAX9mOHmr8qBEmNDbpKg4quBwFxGcicbotsk5YMOSZrAhkXm9hMEl0TYg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p></li><li><p>HTTP 响应（Response）报文，报文格式为：状态行 — HTTP头（通用信息头、请求头、实体头）— 响应报文主体，如图：<br><img src="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UALic2c6WYg1WJqgcPmycZ8iaFNy53ygaMGXUlyQazVHYFbzExq3boCrCw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UALic2c6WYg1WJqgcPmycZ8iaFNy53ygaMGXUlyQazVHYFbzExq3boCrCw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UA81lN1ayibiaT5rWSjnax9ZyQCF6SIbsgsvF8YB0KHkObpK02ITmb2f7w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UA81lN1ayibiaT5rWSjnax9ZyQCF6SIbsgsvF8YB0KHkObpK02ITmb2f7w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p></li></ul></li><li><p>注意：</p><ul><li>通用信息头指的是请求和响应报文都支持的头域，分别为：<code>Cache-Control、Connection、Date、Pragma、Transfer-Encoding、Upgrade、Via</code></li><li>实体头则是实体信息的实体头域，分别为：<code>Allow、Content-Base、Content-Encoding、Content-Language、Content-Length、Content-Location、Content-MD5、Content-Range、Content-Type、Etag、Expires、Last-Modified、extension-header</code></li><li>之前是为了方别理解，而将通用信息头、响应头/请求头、实体头都归为了 HTTP 头</li></ul></li></ol><hr><h2 id="缓存的优点"><a href="#缓存的优点" class="headerlink" title="缓存的优点"></a>缓存的优点</h2><ol><li>减少了冗余的数据传递，节省宽带流量</li><li>减少了服务器的负担，大大提高了网站性能</li><li>加快了客户端加载网页的速度 这也正是HTTP缓存属于客户端缓存的原因</li></ol><hr><h2 id="缓存过程分析"><a href="#缓存过程分析" class="headerlink" title="缓存过程分析"></a>缓存过程分析</h2><ol><li>浏览器与服务器通信的方式是应答模式，即为：浏览器发起 HTTP 请求 — 服务器响应该请求，那么，浏览器第一次向服务器发起该请求后拿到结果，会根据响应报文中的 HTTP 头的缓存标识，决定是否缓存结果，若是，则将请求结果和缓存标识存入浏览器缓存中，如图：<br><img src="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UA8FuX3NsJgyJWQS4RiaBIaOmRYvSNcNcibiam2SqjtV9NXwJdHGRpljZEw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UA8FuX3NsJgyJWQS4RiaBIaOmRYvSNcNcibiam2SqjtV9NXwJdHGRpljZEw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></li><li>由上图可知：<ul><li>浏览器每次发起请求，都会先在浏览器缓存中查找该请求的结果以及缓存标识</li><li>浏览器每次拿到返回的请求结果都会将该结果和缓存标识存入浏览器缓存中</li></ul></li><li>以上两点结论就是浏览器缓存机制的关键，它确保了每个请求的缓存存入与读取，下面开始理解浏览器缓存的使用规则</li></ol><hr><h2 id="缓存的规则"><a href="#缓存的规则" class="headerlink" title="缓存的规则"></a>缓存的规则</h2><h3 id="缓存的分类"><a href="#缓存的分类" class="headerlink" title="缓存的分类"></a>缓存的分类</h3><ol><li>一般来说，浏览器缓存可以分为：<ul><li>强缓存</li><li>协商缓存（对比缓存）</li></ul></li><li>浏览器在加载资源时，会先判断是否命中强缓存，再验证是否命中协商缓存</li></ol><h3 id="强缓存"><a href="#强缓存" class="headerlink" title="强缓存"></a>强缓存</h3><ol><li><p>浏览器在加载资源时，会先根据本地缓存资源的 <code>header</code> 中的信息判断是否命中强缓存，如果命中，则直接使用缓存中的资源，而不会再向服务器发送请求，如图：<br><img src="https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH46gEGrNj33aKfAoWXzuPhFwuhcAHTEc5ciaq8GZorWDQhn9mWiasWQLqiaDZeR3WBd5Blhvml6oBmsPQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH46gEGrNj33aKfAoWXzuPhFwuhcAHTEc5ciaq8GZorWDQhn9mWiasWQLqiaDZeR3WBd5Blhvml6oBmsPQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p></li><li><p>从图中可以看出，强缓存的一般流程是：</p><ul><li>查看 <code>header</code> 头中的 <code>Expire</code> 和 <code>Cache-control</code> 来判断是否满足规则</li><li>如果满足规则，就返回缓存的数据</li><li>如果不满足规则，就向服务器发送请求</li><li>服务器返回数据</li><li>将新数据存入缓存</li></ul></li><li><p>接下来我们主要就关注 <code>Expire</code> 和 <code>Cache-control</code> 这两个字段</p></li><li><p>Expire：</p><ul><li><p>Expires 是 HTTP/1.0 控制网页缓存的字段，其值为服务器返回该请求结果缓存的到期时间，即再次发起该请求时，当客户端的时间小于 Expires 的值时，直接使用缓存结果。</p></li><li><p>再看看 MDN 中如何解释这个字段：</p><blockquote><p>The Expires header contains the date/time after which the response is considered stale.</p></blockquote></li><li><p>这个字段包含了一个时间，过了这个时间，响应将会失效。也就是说，<code>Expire</code> 这个字段表示缓存到期时间，我们来打开一个网站并查看 <code>Response Header</code> 看看这个字段：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Expires:Fri, 27 Oct 2017 07:55:30 GMT</span><br></pre></td></tr></table></figure></li><li><p>可能在你查看这的时候发现时间都已经是过去了 ~，<code>GMT</code> 表示的是格林威治时间，和北京时间相差8小时，上面的这个时间表示的是 <code>2017年10月27日15:55:30</code>。</p></li><li><p>通过设置 <code>Expire</code> 来设置缓存有一个缺点：这个是个绝对时间，也就是说，如果我修改了客户端的本地时间，是不是就会导致判断缓存失效了呢。</p></li><li><p>Expires 是 HTTP/1.0的字段，但是现在浏览器默认使用的是 HTTP/1.1，那么在HTTP/1.1 中网页缓存还是否由 Expires 控制？</p><ul><li>到了 HTTP/1.1，Expire 已经被 Cache-Control 替代，原因在于 Expires 控制缓存的原理是使用客户端的时间与服务端返回的时间做对比，那么如果客户端与服务端的时间因为某些原因（例如时区不同；客户端和服务端有一方的时间不准确）发生误差，那么强制缓存则会直接失效，这样的话强制缓存的存在则毫无意义。接下来我们开始认识 Cache-Control。</li></ul></li></ul></li><li><p>Cache-Control：</p><ul><li><p>在HTTP/1.1中，Cache-Control是最重要的规则，主要用于控制网页缓存。</p></li><li><p>承接上面的例子，既然不能设置绝对时间，那就设置相对时间吧</p></li><li><p>在 <code>HTTP/1.1</code> 中，增加了一个字段 <code>Cache-Control</code> ，它包含一个 <code>max-age</code> 属性，该字段表示资源缓存的最大有效时间，这就是一个相对时间：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cache-Control:max-age&#x3D;600</span><br></pre></td></tr></table></figure></li><li><p>这个表示的就是最大有效时间是 <code>600s</code> ，对的，它的单位是秒。</p></li><li><p><code>Cache-Control</code> 除了 <code>max-age</code> 属性之外还有一些属性：</p><ul><li><code>no-cache</code>：需要进行协商缓存，发送请求到服务器确认是否使用缓存。</li><li><code>no-store</code>：禁止使用缓存，每一次都要重新请求数据。</li><li><code>public</code>：默认设置。</li><li><code>private</code>：不能被多用户共享。</li></ul></li><li><p>接下来，我们直接看一个例子，如下：<br><img src="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAEicgkB9SxLPeF3HdN72RppOXGOaGIRSCDjJia4cwZyUQowR1PXanYFTw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAEicgkB9SxLPeF3HdN72RppOXGOaGIRSCDjJia4cwZyUQowR1PXanYFTw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p></li><li><p>由上面的例子我们可以知道：</p><ul><li>HTTP 响应报文中 Expires 的时间值，是一个绝对值</li><li>HTTP响应报文中 Cache-Control 为 max-age=600，是相对值</li></ul></li><li><p>由于 Cache-Control 的优先级比 Expires，那么直接根据 Cache-Control 的值进行缓存，意思就是说在600秒内再次发起该请求，则会直接使用缓存结果，强制缓存生效。注：在无法确定客户端的时间是否与服务端的时间同步的情况下，Cache-Control 相比于Expires 是更好的选择，所以同时存在时，只有 Cache-Control生效。了解强制缓存的过程后，我们拓展性的思考一下：<strong>浏览器的缓存存放在哪里，如何在浏览器中判断强制缓存是否生效？</strong></p></li><li><p>我们以博客的请求为例，状态码为灰色的请求则代表使用了强制缓存，请求对应的 Size值则代表该缓存存放的位置，分别为 from memory cache 和 from disk cache：<br><img src="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UA7Fq598qw8oo3auVV4icNTYezGoA7Y1eSbhib8gEDUicaXf6yVh9NBDSLA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UA7Fq598qw8oo3auVV4icNTYezGoA7Y1eSbhib8gEDUicaXf6yVh9NBDSLA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p></li><li><p>那么 from memory cache 和 from disk cache又分别代表的是什么呢？什么时候会使用from disk cache，什么时候会使用from memory cache呢？</p></li><li><p>from memory cache 代表使用内存中的缓存，from disk cache 则代表使用的是硬盘中的缓存，浏览器读取缓存的顺序为 <code>memory –&gt; disk</code></p></li><li><p>对于上个结论，我们需要了解内存缓存（from memory cache）和硬盘缓存（from disk cache），如下:</p><ul><li>内存缓存（from memory cache）：内存缓存具有两个特点，分别是快速读取和时效性。</li><li>快速读取：内存缓存会将编译解析后的文件，直接存入该进程的内存中，占据该进程一定的内存资源，以方便下次运行使用时的快速读取。</li><li>时效性：一旦该进程关闭，则该进程的内存则会清空。</li><li>硬盘缓存（from disk cache）：硬盘缓存则是直接将缓存写入硬盘文件中，读取缓存需要对该缓存存放的硬盘文件进行I/O操作，然后重新解析该缓存内容，读取复杂，速度比内存缓存慢。</li></ul></li><li><p>在浏览器中，浏览器会在 js 和图片等文件解析执行后直接存入内存缓存中，那么当刷新页面时只需直接从内存缓存中读取（from memory cache）；而 css 文件则会存入硬盘文件中，所以每次渲染页面都需要从硬盘读取缓存（from disk cache）</p></li></ul></li><li><p>现在基本上都会同时设置 <code>Expire</code> 和 <code>Cache-Control</code> ，<code>Cache-Control</code> 的优先级别更高。</p></li></ol><h3 id="协商缓存"><a href="#协商缓存" class="headerlink" title="协商缓存"></a>协商缓存</h3><ol><li><p>当强缓存没有命中的时，浏览器会发送一个请求到服务器，服务器根据请求头中的部分信息来判断是否命中缓存。如果命中，则返回 <code>304</code> ，告诉浏览器资源未更新，可使用本地的缓存。</p></li><li><p>协商缓存就是强制缓存失效后，浏览器携带缓存标识向服务器发起请求，由服务器根据缓存标识决定是否使用缓存的过程，主要有以下两种情况：</p><ul><li>协商缓存生效，返回304，如下：<br><img src="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAYuh8P5Tmm65mboKQOWg5dW83jAmyxceceYYVSfK8ibbq5GmkGKNghvQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAYuh8P5Tmm65mboKQOWg5dW83jAmyxceceYYVSfK8ibbq5GmkGKNghvQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></li><li>协商缓存失效，返回200和请求结果结果，如下：<img src="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAwSic1Tk9mx9BkHDeQiaoXIBrO4cpicUWlbQv6Mnx0MXXK8YxXGlvl2SzQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAwSic1Tk9mx9BkHDeQiaoXIBrO4cpicUWlbQv6Mnx0MXXK8YxXGlvl2SzQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></li></ul></li><li><p>协商缓存整体流程图：<br><img src="https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH46gEGrNj33aKfAoWXzuPhFw7eLia7lb2a0r0nnZ01kQSST6k4WHK0VuPbqLVwibE6znVF84I4F43IjA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH46gEGrNj33aKfAoWXzuPhFw7eLia7lb2a0r0nnZ01kQSST6k4WHK0VuPbqLVwibE6znVF84I4F43IjA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><ul><li>从图中可以看出，协商缓存一般是这样一个流程：<ul><li>把资源标识，比如 <code>If-Modify-Since</code> 或 <code>Etag</code> 发送到服务器，确认资源是否更新</li><li>如果资源未更新，请求响应返回的http状态为 <code>304</code> 并且会显示一个 <code>Not Modified</code> 的字符串，告诉浏览器使用本地缓存</li><li>如果资源已经更新，返回新的数据</li><li>将新数据存入缓存</li></ul></li></ul></li><li><p>Last-Modified / If-Modified-Since：</p><ul><li><p><code>Last-Modified</code> 是浏览器第一次请求资源的时候，服务器返回的 <code>header</code> 上会带有一个 <code>Last-Modified</code> 字段，服务器响应请求时，返回该资源文件在服务器最后被修改的时间，如下：<br><img src="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAabMhy3YmTiarkDQJYyibak7WNEic5OsapqOgpnS0DJBc7ia5azajD1D9yg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAabMhy3YmTiarkDQJYyibak7WNEic5OsapqOgpnS0DJBc7ia5azajD1D9yg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p></li><li><p>同样的，这是一个 <code>GMT</code> 的绝对时间。</p></li><li><p><code>If-Modified-Since</code> 则是客户端再次发起该请求时，携带上次请求返回的 <code>Last-Modified</code> 值，通过此字段值告诉服务器该资源上次请求返回的最后被修改时间。服务器收到该请求，发现请求头含有 <code>If-Modified-Since</code> 字段，则会根据 <code>If-Modified-Since</code> 的字段值与该资源在服务器的最后被修改时间做对比，若服务器的资源最后被修改时间大于 <code>If-Modified-Since</code> 的字段值，则重新返回资源，状态码为200；否则则返回304，代表资源无更新，可继续使用缓存文件，如下：<br><img src="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAXKRPNx7nUE9OR4ibo5mMRKdrzcIH9MIXX52WwcddWhae9O6kSwExHPQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAXKRPNx7nUE9OR4ibo5mMRKdrzcIH9MIXX52WwcddWhae9O6kSwExHPQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p></li><li><p>当然，这个方法也是有缺点的：</p><ul><li>最小单位是秒。也就是说如果我短时间内资源发生了改变，<code>Last-Modified</code> 并不会发生变化；</li><li>周期性变化。如果这个资源在一个周期内修改回原来的样子了，我们认为是可以使用缓存的，但是 <code>Last-Modified</code> 可不这样认为。</li></ul></li><li><p>所以，后来又引入一个 <code>Etag</code></p></li></ul></li><li><p>Etag：</p><ul><li><code>Etag</code> 是服务器响应请求时，返回当前资源文件的一个唯一标识(由服务器生成)，如下：<br><img src="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAicSQxy35icJVqPicqhnaMG8uxhQuiaoL06ic8DEJu2zRAG0ZjgYEpcwxrKA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAicSQxy35icJVqPicqhnaMG8uxhQuiaoL06ic8DEJu2zRAG0ZjgYEpcwxrKA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></li><li><code>If-None-Match</code>c是客户端再次发起该请求时，携带上次请求返回的唯一标识 <code>Etag</code> 值，通过此字段值告诉服务器该资源上次请求返回的唯一标识值。服务器收到该请求后，发现该请求头中含有 <code>If-None-Match</code>，则会根据 <code>If-None-Match</code> 的字段值与该资源在服务器的 <code>Etag</code> 值做对比，一致则返回304，代表资源无更新，继续使用缓存文件；不一致则重新返回资源文件，状态码为200，如下：<br><img src="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAS11SqbSBOLW3caGq6KjbDVCNQsS4MJHZxSKYmoPQverXZ6h9XMuKYg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UAS11SqbSBOLW3caGq6KjbDVCNQsS4MJHZxSKYmoPQverXZ6h9XMuKYg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></li><li>它一般是由文件内容 <code>hash</code> 生成的，也就是说它可以保证资源的唯一性，资源发生改变就会导致 <code>Etag</code>发生改变。</li><li>同样地，在浏览器第一次请求资源时，服务器会返回一个 <code>Etag</code> 标识。当再次请求该资源时， 会通过 <code>If-no-match</code> 字段将 <code>Etag</code> 发送回服务器，然后服务器进行比较，如果相等，则返回 <code>304</code> 表示未修改。</li><li><code>Last-Modified</code> 和 <code>Etag</code> 是可以同时设置的，服务器会优先校验 <code>Etag</code>，如果 <code>Etag</code> 相等就会继续比对 <code>Last-Modified</code>，最后才会决定是否返回 <code>304</code>。</li><li><code>Etag / If-None-Match</code> 优先级高于 <code>Last-Modified / If-Modified-Since</code>，同时存在则只有 <code>Etag / If-None-Match</code> 生效。</li></ul></li></ol><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol><li>强制缓存优先于协商缓存进行，若强制缓存（Expires和Cache-Control）生效则直接使用缓存，若不生效则进行协商缓存（Last-Modified / If-Modified-Since和Etag / If-None-Match），</li><li>协商缓存由服务器决定是否使用缓存，若协商缓存失效，那么代表该请求的缓存失效，重新获取请求结果，再存入浏览器缓存中；生效则返回304，继续使用缓存</li><li>总结的主要过程如下：<br><img src="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UA6eZ3dqoKdgIhPENicUjaXXict6LuQDYsGNHFrddiayooqibHN50ZUCbYog/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" class="lazyload" data-srcset="https://mmbiz.qpic.cn/mmbiz_png/meG6Vo0Mevgq38cXiaLvaxNIiatrA806UA6eZ3dqoKdgIhPENicUjaXXict6LuQDYsGNHFrddiayooqibHN50ZUCbYog/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></li><li>即，当浏览器再次访问一个已经访问过的资源时，它会这样做：<ul><li>看看是否命中强缓存，如果命中，就直接使用缓存了；</li><li>如果没有命中强缓存，就发请求到服务器检查是否命中协商缓存；</li><li>如果命中协商缓存，服务器会返回 <code>304</code> 告诉浏览器使用本地缓存；</li><li>否则，返回最新的资源。</li></ul></li></ol><hr><h2 id="用户对缓存的影响"><a href="#用户对缓存的影响" class="headerlink" title="用户对缓存的影响"></a>用户对缓存的影响</h2><p>若是问到用户进行一些操作的时候，对缓存是有什么影响的，答案如下：</p><table><thead><tr><th align="center"><strong>用户操作</strong></th><th align="center"><strong>Expires/Cache-Control</strong></th><th align="center"><strong>Last-Modified/Etag</strong></th></tr></thead><tbody><tr><td align="center">地址栏回车</td><td align="center">√</td><td align="center">√</td></tr><tr><td align="center">页面链接跳转</td><td align="center">√</td><td align="center">√</td></tr><tr><td align="center">新开窗口</td><td align="center">√</td><td align="center">√</td></tr><tr><td align="center">前进回退</td><td align="center">√</td><td align="center">√</td></tr><tr><td align="center">F5 刷新</td><td align="center">×</td><td align="center">√</td></tr><tr><td align="center">Ctrl+F5 强制刷新</td><td align="center">×</td><td align="center">×</td></tr></tbody></table><hr><h2 id="不同刷新的请求执行过程"><a href="#不同刷新的请求执行过程" class="headerlink" title="不同刷新的请求执行过程"></a>不同刷新的请求执行过程</h2><ol><li>URL（最快）：浏览器地址栏中写入URL，回车，浏览器发现缓存中有这个文件了，不用继续请求了，直接去缓存拿。</li><li>F5：告诉浏览器去服务器看看这个文件是否有过期了。于是浏览器就发送一个请求带上 <code>If-Modify-since</code>。</li><li>Ctrl+F5：让浏览器先把缓存中的文件删了，然后再去服务器请求个完整的资源文件下来，于是客户端就完成了强行更新的操作。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 探索笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 探索笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Next.js入门笔记</title>
      <link href="13c3110fab14/"/>
      <url>13c3110fab14/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><ol><li>初识 Next.js，请查看它的官网介绍：<ul><li><a href="https://nextjs.org/">Next.js 官网</a></li><li><a href="https://www.nextjs.cn/">Next.js 中文网</a></li></ul></li><li>好吧，官网的话总是那么拗口，毫不避讳地说，我的能力还完全不能对某某框架指评，若对此感兴趣，请读者移步知乎：<a href="https://www.zhihu.com/search?type=content&q=nextjs">对 Next.js 的评价</a></li><li>另外附上两个你可能会用到的链接：<ul><li>Github 地址：<a href="https://github.com/zeit/next.js">Github - next.js</a></li><li>社区：<a href="https://spectrum.chat/next-js">Spectrum</a></li></ul></li></ol><hr><h2 id="初识Next-js"><a href="#初识Next-js" class="headerlink" title="初识Next.js"></a>初识Next.js</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ol><li>Next.js 支持 Windows、Mac 和 Linux系统，均可安装，但是前提是你已经安装了 Node.js</li><li>创建示例项目的过程如下： <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> hello-next</span><br><span class="line"><span class="built_in">cd</span> hello-next</span><br><span class="line">npm init -y</span><br><span class="line">npm install --save react react-dom next</span><br><span class="line"><span class="built_in">mkdir</span> pages</span><br></pre></td></tr></table></figure></li></ol><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ol><li>打开 <code>hello-next/package.json</code>，替换 <code>scripts</code>： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;dev&quot;</span>: <span class="string">&quot;next&quot;</span>,</span><br><span class="line"><span class="string">&quot;build&quot;</span>: <span class="string">&quot;next build&quot;</span>,</span><br><span class="line"><span class="string">&quot;start&quot;</span>: <span class="string">&quot;next start&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>启动 <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run dev</span><br></pre></td></tr></table></figure> 在浏览器中打开 <a href="http://localhost:3000/">http://localhost:3000</a>,你会看到页面显示 <strong>404 | This page could not be found</strong>.</li><li>创建你的第一个页面<ul><li>创建 <code>pages/index.js</code>，并输入：  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Index = <span class="function">() =&gt;</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;p&gt;Hello Next.js&lt;/p&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Index;</span><br></pre></td></tr></table></figure></li><li>再次输入 <code>npm run dev</code>，就能看到效果了</li><li>上述案例中，我们在 <code>pages/index.js</code> 模块中默认（default）导出了一个简单的 React 组件</li></ul></li><li>试错<ul><li>尝试着错一次：将 <code>pages/index.js</code> 改为：  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Index = <span class="function">() =&gt;</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;p&gt;Hello Next.js</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Index;</span><br></pre></td></tr></table></figure></li><li>重新启动，浏览器显示：<br>  <img src="https://s2.ax1x.com/2020/02/14/1XeRmQ.png" class="lazyload" data-srcset="https://s2.ax1x.com/2020/02/14/1XeRmQ.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></li><li>一般情况下，Next.js 将跟踪此类错误并在浏览器中显示，这便于我们快速发现错误，而你修改代码并保存后，页面将立即出现对应结果，而不会重新加载整个页面，这是通过 webpack 的 <strong><a href="https://webpack.js.org/concepts/hot-module-replacement/">模块热替换</a></strong> 实现的，Next 默认支持这个功能</li></ul></li></ol><hr><p>2020.3.30</p><h2 id="页面间导航"><a href="#页面间导航" class="headerlink" title="页面间导航"></a>页面间导航</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><ol><li>我们的应用程序虽然很简单，只有一个页面，但是我们可以添加任意多个页面，例如：<ul><li>创建 <code>pages/about.js</code> 来新建 “About” 页面  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> About = <span class="function">() =&gt;</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;p&gt;About Page&lt;/p&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> About;</span><br></pre></td></tr></table></figure></li><li>修改 <code>pages/index.js</code>：  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Index = <span class="function">() =&gt;</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;p&gt;Hello Next.js&lt;/p&gt;</span><br><span class="line">    &lt;a href=<span class="string">&quot;http://localhost:3000/about&quot;</span>&gt;This is a link to About-Page&lt;/a&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Index;</span><br></pre></td></tr></table></figure></li><li>之后我们可以通过 <a href="http://localhost:3000/about">http://localhost:3000/about</a> 来访问该页面</li><li>之后，我们需要连接两个页面，首先想到的是可以用一个 HTML 的 <code>&lt;a /&gt;</code> 标签实现，但是结果就是：浏览器会向服务器请求下一页并刷新当前页面，也就是这样做并不会执行客户端导航</li></ul></li><li>为了支持浏览器端导航，我们需要使用 Next.js 提供的 <code>Link</code> 组件，这个组件是通过 <code>next/link</code> 导出的，接下来我们将使用它</li><li>我们需要准备一个简单的 Next.js 应用课程，请在 <code>hello-next</code> 下输入： <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/zeit/next-learn-demo.git</span><br></pre></td></tr></table></figure></li><li>现在我们进入 <code>hello-next/next-learn-demo/1-navigate-between-pages</code> 启动程序： <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> next-learn-demo/<span class="number">1</span>-navigate-between-pages</span><br><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure><ul><li>打开 <a href="http://localhost:3000/">http://localhost:3000/</a> 访问该程序</li></ul></li></ol><h3 id="使用Link组件"><a href="#使用Link组件" class="headerlink" title="使用Link组件"></a>使用Link组件</h3><blockquote><p>注意，接下来的操作均在 <code>hello-next/next-learn-demo/1-navigate-between-pages</code> 下完成的</p></blockquote><ol><li>在 <code>pages/index.js</code> 中添加： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Link <span class="keyword">from</span> <span class="string">&#x27;next/link&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Index</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;Hello next.js&lt;/p&gt;</span><br><span class="line">      &lt;Link href=<span class="string">&quot;/about&quot;</span>&gt;</span><br><span class="line">        &lt;a&gt;About Page&lt;/a&gt;</span><br><span class="line">      &lt;/Link&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在这里，我们将 <code>next/link</code> 导入为 <code>Link</code>，并按照如下的方式使用：  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Link href=<span class="string">&quot;/about&quot;</span>&gt;</span><br><span class="line">  &lt;a&gt;About Page&lt;/a&gt;</span><br><span class="line">&lt;/Link&gt;</span><br></pre></td></tr></table></figure></li><li>访问 3000 端口可查看结果</li></ul></li><li>这次点击链接同样会导航到 “About” 页面，这是客户端导航，操作在浏览器中进行，而不向浏览器发送请求，你可以通过打开浏览器的 <strong>网络请求检查器（network request inspector）</strong> 来验证这一点</li><li>后退按钮：<br> 当你点击链接，再点击后退时，依然会切换到历史记录的上一页，也就是 <code>next/link</code> 为你完成了所有 <code>location.history</code> 的操作</li></ol><h3 id="添加链接道具"><a href="#添加链接道具" class="headerlink" title="添加链接道具"></a>添加链接道具</h3><ol><li>或许你需要在连接中添加属性或道具，比如你需要向链接中添加 <code>title</code> 属性，我们可以这样添加它： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Link href=<span class="string">&quot;/about&quot;</span>&gt;</span><br><span class="line">&lt;a title=<span class="string">&quot;About-Pages&quot;</span>&gt;About Page&lt;/a&gt;</span><br><span class="line">&lt;/Link&gt;</span><br></pre></td></tr></table></figure> 查看元素，可以看到结果如下：<br> <img src="https://s2.ax1x.com/2020/02/14/1XGSVf.png" class="lazyload" data-srcset="https://s2.ax1x.com/2020/02/14/1XGSVf.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></li><li>切记不可添加到错误的地方去，若写成如下： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Link href=<span class="string">&quot;/about&quot;</span> title=<span class="string">&quot;About-Pages&quot;</span>&gt;</span><br><span class="line">&lt;a&gt;About Page&lt;/a&gt;</span><br><span class="line">&lt;/Link&gt;</span><br></pre></td></tr></table></figure> 则会在控制台中报错：<br> <img src="https://s2.ax1x.com/2020/02/14/1XJPw6.png" class="lazyload" data-srcset="https://s2.ax1x.com/2020/02/14/1XJPw6.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></li><li>实际上，<code>Link</code> 组件上的标题道具无效，是因为 Link 只是一个包装器组件，只接收 <code>href</code> 和一些类似的道具。如果需要向其添加道具，则需要将道具添加到其子项，这种情况下，<code>Link</code> 组件的子代是锚标记</li></ol><hr><h2 id="使用共享组件"><a href="#使用共享组件" class="headerlink" title="使用共享组件"></a>使用共享组件</h2><h3 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h3><ol><li>我们可以通过导出 React 组件并将该组件放在 <code>pages</code> 目录中来创建页面，每个页面的 URL 都是基于文件名的，由于导出的页面是 JavaScript 模块，因此我们也可以将其他 JavaScript 组件导入其中</li><li>我们将创建一个公共的 Header 组件并将其用于多个页面，最后我们将研究实现 Layout 组件，并了解它如何帮我们定义多个页面的外观</li></ol><h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><ol><li>我们之前已经安装过了 <code>next-learn-demo</code>，这里直接使用：<ul><li>进入 <code>hello-next/next-learn-demo/2-using-shared-components</code>，之后我们的操作也会在此目录下</li></ul></li><li>运行： <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure></li></ol><h3 id="创建标题组件"><a href="#创建标题组件" class="headerlink" title="创建标题组件"></a>创建标题组件</h3><ol><li>下面创建一个 Header 组件，创建 <code>2-using-shared-components/components/Header.js</code>： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Link <span class="keyword">from</span> <span class="string">&#x27;next/link&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> linkStyle = &#123;</span><br><span class="line">  marginRight: <span class="number">15</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Header = <span class="function">() =&gt;</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;Link href=<span class="string">&quot;/&quot;</span>&gt;</span><br><span class="line">      &lt;a style=&#123;marginRight&#125;&gt;Home&lt;/a&gt;</span><br><span class="line">    &lt;/Link&gt;</span><br><span class="line">    &lt;Link href=<span class="string">&quot;/about&quot;</span>&gt;</span><br><span class="line">      &lt;a style=&#123;marginRight&#125;&gt;About&lt;/a&gt;</span><br><span class="line">    &lt;/Link&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Header;</span><br></pre></td></tr></table></figure></li><li>现在，导入 Header 组件并在页面中使用它：<ul><li>将 <code>index.js</code> 修改为：  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Header <span class="keyword">from</span> <span class="string">&#x27;../components/Header&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Index</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">&lt;div&gt;</span><br><span class="line">  &lt;Header /&gt;</span><br><span class="line">  &lt;p&gt;Hello Next.js&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>将 <code>about.js</code> 修改为：  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Header <span class="keyword">from</span> <span class="string">&#x27;../components/Header&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Index</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Header /&gt;</span><br><span class="line">      &lt;p&gt;This is the About Page&lt;/p&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>启动之后可以查看结果</li></ul></li><li>试错：现在将 <code>components</code> 目录改名为 <code>comps</code>，报错如下：<br> <img src="https://s2.ax1x.com/2020/02/14/1jmeGq.png" class="lazyload" data-srcset="https://s2.ax1x.com/2020/02/14/1jmeGq.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="><ul><li>我们不需要将我们的组件放在一个特殊的目录里，也就是说，该组件目录名称可以取为任何，实际上，唯一特殊的目录是 <code>/pages</code> 和 <code>/public</code>，你甚至可以在 <code>/pages</code> 里面创建组件.</li></ul></li></ol><h3 id="布局组件"><a href="#布局组件" class="headerlink" title="布局组件"></a>布局组件</h3><blockquote><p>本节依然是在 <code>2-using-shared-components/</code> 下完成的</p></blockquote><ol><li>我们将创建 Layout 组件，以实现各页面上的通用样式，在 <code>components/MyLayout.js</code> 中输入： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Header <span class="keyword">from</span> <span class="string">&#x27;./Header&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> layoutStyle = &#123;</span><br><span class="line">  margin: <span class="number">20</span>,</span><br><span class="line">  padding: <span class="number">20</span>,</span><br><span class="line">  border: <span class="string">&#x27;1px solid #DDD&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Layout = <span class="function"><span class="params">props</span> =&gt;</span> (</span><br><span class="line">  &lt;div style=&#123;layoutStyle&#125;&gt;</span><br><span class="line">    &lt;Header /&gt;</span><br><span class="line">    &#123;props.children&#125;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Layout;</span><br></pre></td></tr></table></figure></li><li>完成操作后，我们可以在页面中使用以下布局：<ul><li>在 <code>pages/index.js</code> 中输入：  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">&#x27;../components/MyLayout&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Index</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Layout&gt;</span><br><span class="line">      &lt;p&gt;Hello Next.js&lt;/p&gt;</span><br><span class="line">    &lt;/Layout&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>在 <code>pages/about.js</code> 中输入：  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">&#x27;../components/MyLayout&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">About</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Layout&gt;</span><br><span class="line">      &lt;p&gt;This is the about page&lt;/p&gt;</span><br><span class="line">    &lt;/Layout&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>启动，查看样式</li></ul></li><li>试错：将 <code>MyLayout.js</code> 中的 <code>&#123;props.children&#125;</code> 删除，再启动，观察结果：<ul><li>页面上只保留了 <code>Header</code> 的内容，其他的均消失了</li></ul></li></ol><h3 id="渲染子组件"><a href="#渲染子组件" class="headerlink" title="渲染子组件"></a>渲染子组件</h3><ol><li>前一个试错中，我们删除了 <code>&#123;props.children&#125;</code>，则 <code>Layout</code> 无法呈现我们放入 <code>Layout</code> 元素内的内容，如下所示： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">About</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Layout&gt;</span><br><span class="line">      &lt;p&gt;This is the about page&lt;/p&gt;</span><br><span class="line">    &lt;/Layout&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 但这只是创建布局组件的一种方法，以下是其他方法。</li><li>方法一：布局为高阶组件 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// components/MyLayout.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Header <span class="keyword">from</span> <span class="string">&#x27;./Header&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> layoutStyle = &#123;</span><br><span class="line">  margin: <span class="number">20</span>,</span><br><span class="line">  padding: <span class="number">20</span>,</span><br><span class="line">  border: <span class="string">&#x27;1px solid #DDD&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> withLayout = <span class="function"><span class="params">Page</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> (</span><br><span class="line">    &lt;div style=&#123;layoutStyle&#125;&gt;</span><br><span class="line">      &lt;Header /&gt;</span><br><span class="line">      &lt;Page /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withLayout;</span><br></pre></td></tr></table></figure> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> withLayout <span class="keyword">from</span> <span class="string">&#x27;../components/MyLayout&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Page = <span class="function">() =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello Next.js<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withLayout(Page);</span><br></pre></td></tr></table></figure> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/about.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> withLayout <span class="keyword">from</span> <span class="string">&#x27;../components/MyLayout&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Page = <span class="function">() =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>This is the about page<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withLayout(Page);</span><br></pre></td></tr></table></figure></li><li>方法二：页面内容作为道具 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// components/MyLayout.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Header <span class="keyword">from</span> <span class="string">&#x27;./Header&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> layoutStyle = &#123;</span><br><span class="line">  margin: <span class="number">20</span>,</span><br><span class="line">  padding: <span class="number">20</span>,</span><br><span class="line">  border: <span class="string">&#x27;1px solid #DDD&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Layout = <span class="function"><span class="params">props</span> =&gt;</span> (</span><br><span class="line">  &lt;div style=&#123;layoutStyle&#125;&gt;</span><br><span class="line">    &lt;Header /&gt;</span><br><span class="line">    &#123;props.content&#125;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Layout;</span><br></pre></td></tr></table></figure> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">&#x27;../components/MyLayout.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> indexPageContent = <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello Next.js<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Index</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Layout</span> <span class="attr">content</span>=<span class="string">&#123;indexPageContent&#125;</span> /&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/about.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">&#x27;../components/MyLayout.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> aboutPageContent = <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>This is the about page<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">About</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Layout</span> <span class="attr">content</span>=<span class="string">&#123;aboutPageContent&#125;</span> /&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><hr><h2 id="创建动态页面"><a href="#创建动态页面" class="headerlink" title="创建动态页面"></a>创建动态页面</h2><h3 id="Introduction-2"><a href="#Introduction-2" class="headerlink" title="Introduction"></a>Introduction</h3><ol><li>之前通过使用组件，我们创建了包含了多个页面的小案例，之前为了创建一个页面，我们必须新建一个文件作为模块导出，但是在一个真正的应用程序中，我们还需动态地创建页面以显示动态内容，接下来我们会使用 <strong>查询字符串</strong> 来实现这一点</li><li>我们将创建一个简单的博客应用，它在主页上展示一个所有文章的列表，展示如下：<ul><li>主页有文章列表<br><img src="https://s2.ax1x.com/2020/02/16/3pmcK1.png" class="lazyload" data-srcset="https://s2.ax1x.com/2020/02/16/3pmcK1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></li><li>点击某标题的链接，会出现对应的文章<br><img src="https://s2.ax1x.com/2020/02/16/3pnPrq.png" class="lazyload" data-srcset="https://s2.ax1x.com/2020/02/16/3pnPrq.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></li></ul></li></ol><h3 id="安装设置"><a href="#安装设置" class="headerlink" title="安装设置"></a>安装设置</h3><ol><li>我们仍然使用之前安装过的 <code>next-learn-demo</code>，进入 <code>next-learn-demo/3-create-dynamic-pages</code>，接下来的一切也将在这个目录下完成</li><li>运行 <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure></li></ol><h3 id="添加文章列表"><a href="#添加文章列表" class="headerlink" title="添加文章列表"></a>添加文章列表</h3><ol><li>首先，我们在文章主页添加标题列表，如下： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Link <span class="keyword">from</span> <span class="string">&#x27;next/link&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">&#x27;../components/MyLayout.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PostLink = <span class="function"><span class="params">props</span> =&gt;</span> (</span><br><span class="line">  &lt;li&gt;</span><br><span class="line">    &lt;Link href=&#123;<span class="string">`/post?title=<span class="subst">$&#123;props.title&#125;</span>`</span>&#125;&gt;</span><br><span class="line">      &lt;a&gt;&#123;props.title&#125;&lt;/a&gt;</span><br><span class="line">    &lt;/Link&gt;</span><br><span class="line">  &lt;/li&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Blog</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Layout&gt;</span><br><span class="line">      &lt;h1&gt;My Blog&lt;/h1&gt;</span><br><span class="line">      &lt;ul&gt;</span><br><span class="line">        &lt;PostLink title=<span class="string">&quot;Hello Next.js&quot;</span> /&gt;</span><br><span class="line">        &lt;PostLink title=<span class="string">&quot;Learn Next.js is awesome&quot;</span> /&gt;</span><br><span class="line">        &lt;PostLink title=<span class="string">&quot;Deploy apps with Zeit&quot;</span> /&gt;</span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">    &lt;/Layout&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="通过查询字符串传递数据"><a href="#通过查询字符串传递数据" class="headerlink" title="通过查询字符串传递数据"></a>通过查询字符串传递数据</h3></li><li>我们将通过查询字符串作为参数（也称查询参数）并传递数据，如： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PostLink = <span class="function"><span class="params">props</span> =&gt;</span> (</span><br><span class="line">  &lt;li&gt;</span><br><span class="line">    &lt;Link href=&#123;<span class="string">`/post?title=<span class="subst">$&#123;props.title&#125;</span>`</span>&#125;&gt;</span><br><span class="line">      &lt;a&gt;&#123;props.title&#125;&lt;/a&gt;</span><br><span class="line">    &lt;/Link&gt;</span><br><span class="line">  &lt;/li&gt;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul><li>此例中，查询参数是 <code>title</code>，我们使用 <code>PostLink</code> 来执行的操作</li><li>你也可以检查 <code>Link</code> 组件的 <code>href</code> 属性，以此类推，你可以使用查询字符串传递任何类型的数据</li></ul></li></ol><h3 id="创建Post页面"><a href="#创建Post页面" class="headerlink" title="创建Post页面"></a>创建<code>Post</code>页面</h3><ol><li>现在我们需要创建 post 页面来显示博客文章，为此，我们需要从查询字符串中获得标题，</li><li>创建 <code>pages/post.js</code> 文件： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;next/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">&#x27;../components/MyLayout&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Page = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> router = useRouter();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Layout&gt;</span><br><span class="line">      &lt;h1&gt;&#123;router.query.title&#125;&lt;/h1&gt;</span><br><span class="line">      &lt;p&gt;This is the blog post content.&lt;/p&gt;</span><br><span class="line">    &lt;/Layout&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Page;</span><br></pre></td></tr></table></figure><ul><li>启动项目，并点击三个标题链接</li></ul></li><li>上面的运作过程如下：<ul><li>首先从 <code>next/router</code> 导入并使用 <code>useRouter</code> 函数，该函数返回 Next.js 的是 <code>router</code> 对象</li><li>使用路由器（router）中的 <code>query</code> 对象，该对象保存了所有查询参数</li><li>然后，使用 <code>router.query.title</code> 获取标题</li></ul></li><li>useRouter 函数的介绍：<ul><li><a href="https://www.nextjs.cn/docs/api-reference/next/router#userouter">useRouter</a> 允许你访问页面中的 router 对象，它是一个 <a href="https://reactjs.org/docs/hooks-intro.html">React Hook</a>，能与功能组件协同合工作</li><li>之前的示例中，useRouter 函数被放到预添加的页面组件中，而下面示例中，useRouter 函数在 <code>Content</code> 组件中，预添加的组件是 <code>Page</code>，但是功能不变  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;next/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">&#x27;../components/MyLayout&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Content = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> router = useRouter();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;h1&gt;&#123;router.query.title&#125;&lt;/h1&gt;</span><br><span class="line">      &lt;p&gt;This is the blog post content.&lt;/p&gt;</span><br><span class="line">    &lt;/&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Page = <span class="function">() =&gt;</span> (</span><br><span class="line">  &lt;Layout&gt;</span><br><span class="line">    &lt;Content /&gt;</span><br><span class="line">  &lt;/Layout&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Page;</span><br></pre></td></tr></table></figure></li></ul></li></ol><hr><h2 id="使用动态路由清理URL"><a href="#使用动态路由清理URL" class="headerlink" title="使用动态路由清理URL"></a>使用动态路由清理URL</h2><h3 id="Introduction-3"><a href="#Introduction-3" class="headerlink" title="Introduction"></a>Introduction</h3><blockquote><p>请确保你正在使用是 Next.js 9 或更高版本<br>接下来的操作都会在 <code>next-learn-demo/4-clean-urls</code> 中进行，请调至指定目录</p></blockquote><ol><li>我们已经知道了如何使用查询字符串创建动态页面，指向我们的某个博客文章的链接如： <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http：&#x2F;&#x2F; localhost：3000 &#x2F; post？title &#x3D; Hello％20Next.js</span><br></pre></td></tr></table></figure> 而此链接要表达的却是： <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http：&#x2F;&#x2F; localhost：3000 &#x2F; p &#x2F; hello-nextjs</span><br></pre></td></tr></table></figure></li></ol><h3 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h3><ol><li>启动项目，在 <code>4-clean-urls/</code> 下输入： <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure></li><li>我们将使用 Next.js 的 <a href="https://nextjs.org/docs/routing/dynamic-routes">动态路由</a> 功能，它允许你处理 <code>/pages</code> 动态路由</li><li>现在我们将创建新页面，并命名为 <code>pages/p/[id].js</code>，这也是我们创建的第一个动态路由，步骤如下：<ul><li>首先，在 <code>/pages</code> 内添加文件夹 <code>/p</code></li><li>然后，你需要在 <code>/p</code> 文件夹中创建 <code>[id].js</code>，并在这些 js 文件中添加如下内容：  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;next/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">&#x27;../../components/MyLayout&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Post</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> router = useRouter();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Layout&gt;</span><br><span class="line">      &lt;h1&gt;&#123;router.query.id&#125;&lt;/h1&gt;</span><br><span class="line">      &lt;p&gt;This is the blog post content.&lt;/p&gt;</span><br><span class="line">    &lt;/Layout&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul></li><li>前一页是特殊的，它不会处理 <code>/about</code> 等静态路由，而是会处理 <code>p/</code> 之后的路由，例如，此页面将处理 <code>/p/hello-next.js</code>，而 <code>/p/post-1/another</code></li><li>页面名称中的带有方括号（<code>[]</code>）使其成为动态路由，你不能使页面名称的一部分成为动态名称，而只能使全名成为动态名称，例如，支持 <code>/pages/p/[id].js</code>，但不支持 <code>/pages/p/post-[id].js</code></li><li>创建动态路线时，我们在方括号（[]）之间添加了 id，这是页面接受到查询参数的名称，因此对于 <code>/p/hello-nextjs</code>，该 <code>query</code> 对象将具有 <code>&#123; id: &#39;hello-nextjs&#39; &#125;</code>，我们可以使用 <a href="https://nextjs.org/docs/api-reference/next/router#userouter">useRouter()</a> 进行访问</li><li>现在，我们新的动态路由添加多个链接，修改 <code>pages/index.js</code>： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">&#x27;../components/MyLayout&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> Link <span class="keyword">from</span> <span class="string">&#x27;next/link&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PostLink = <span class="function"><span class="params">props</span> =&gt;</span> (</span><br><span class="line">  &lt;li&gt;</span><br><span class="line">    &lt;Link href=<span class="string">&quot;/p/[id]&quot;</span> <span class="keyword">as</span>=&#123;<span class="string">`/p/<span class="subst">$&#123;props.id&#125;</span>`</span>&#125;&gt;</span><br><span class="line">      &lt;a&gt;&#123;props.id&#125;&lt;/a&gt;</span><br><span class="line">    &lt;/Link&gt;</span><br><span class="line">  &lt;/li&gt;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Blog</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Layout&gt;</span><br><span class="line">      &lt;h1&gt;My Blog&lt;/h1&gt;</span><br><span class="line">      &lt;ul&gt;</span><br><span class="line">        &lt;PostLink id=<span class="string">&quot;Hello-Next.js&quot;</span> /&gt;</span><br><span class="line">        &lt;PostLink id=<span class="string">&quot;Learn-Next.js&quot;</span> /&gt;</span><br><span class="line">        &lt;PostLink id=<span class="string">&quot;Deploy-Next.js&quot;</span> /&gt;</span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">    &lt;/Layout&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>着重看看以下内容：  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PostLink = <span class="function"><span class="params">props</span> =&gt;</span> (</span><br><span class="line">  &lt;li&gt;</span><br><span class="line">    &lt;Link href=<span class="string">&quot;/p/[id]&quot;</span> <span class="keyword">as</span>=&#123;<span class="string">`/p/<span class="subst">$&#123;props.id&#125;</span>`</span>&#125;&gt;</span><br><span class="line">      &lt;a&gt;&#123;props.id&#125;&lt;/a&gt;</span><br><span class="line">    &lt;/Link&gt;</span><br><span class="line">  &lt;/li&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><ul><li>在 <code>&lt;Link&gt;</code> 元素中，<code>href</code> 代表的是该页面在 <code>pages</code> 文件夹中的路径，而 <code>as</code> 代表的是该页面在浏览器中的 URL 路径</li></ul></li><li>现在，你可以重新启动项目，注意观察 URL 的变化！<br>  <img src="https://s2.ax1x.com/2020/02/17/3CmhPU.png" class="lazyload" data-srcset="https://s2.ax1x.com/2020/02/17/3CmhPU.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></li></ul></li><li>动态路由可以很好地和浏览器历史记录配合使用，而我们要做的就是将 <code>as</code> 添加到链接组件中</li></ol><hr><h2 id="为页面获取数据"><a href="#为页面获取数据" class="headerlink" title="为页面获取数据"></a>为页面获取数据</h2><h3 id="Introduction-4"><a href="#Introduction-4" class="headerlink" title="Introduction"></a>Introduction</h3><blockquote><p>接下来的操作都会在 <code>next-learn-demo/6-fetching-data</code> 中进行，请调至指定目录</p></blockquote><ol><li>现在我们已经能创建一个相对完整的 Next.js 应用，但还没有解决的是：<strong>如何从远程数据源中获取数据？</strong>，Next.js 提供了一个标准 API 来获取页面所需的数据，即 <strong><code>getInitialProps 异步函数</code></strong></li><li><code>getInitialProps</code> 只能添加到页面导出的默认组件中，在其他组件中是不会起作用的，它可以从远程数据源为指定页面获取数据，并将这些数据通过 props 传递到我们的页面，它会同时在客户端和服务器上工作，因为它在两个环境中都会被调用</li><li>我们将利用 <code>getInitialProps</code> 构建一个应用程序来显示有关 Batman TV Shows 的信息，利用的是公开的 <a href="https://www.tvmaze.com/api">TVmaze API</a></li><li>在即将演示的示例中，我们的主页上有一个文章列表，现在我们来展示 <code>Batman TV shows</code> 的节目列表，我们将从远程服务器上获取这些节目列表，而不是硬编码<ul><li>在这个示例中，我们使用的是 <a href="https://www.tvmaze.com/api">TVMaze API</a> 来获取 TV shows 节目列表，这是一个搜索电视节目的 API</li></ul></li></ol><h3 id="安装设置-1"><a href="#安装设置-1" class="headerlink" title="安装设置"></a>安装设置</h3><ol><li>进入 <code>next-learn-demo/6-fetching-data</code>，输入： <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure></li><li>在浏览器中打开 <a href="http://localhost:3000/">http://localhost:3000/</a> 查看项目</li></ol><h3 id="获取BatmanShows的数据"><a href="#获取BatmanShows的数据" class="headerlink" title="获取BatmanShows的数据"></a>获取BatmanShows的数据</h3><ol><li>首先，我们需要安装 <a href="https://github.com/developit/unfetch">isomorphic-unfetch</a>，这是我们用来获取数据的工具库，这是浏览器的 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch">fetch API</a> 的一个简单实现，但在客户端和服务器环境中都可以使用 <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save isomorphic-unfetch</span><br></pre></td></tr></table></figure></li><li>将 <code>pages/index.js</code> 替换为以下内容： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">&#x27;../components/MyLayout&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> Link <span class="keyword">from</span> <span class="string">&#x27;next/link&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> fetch <span class="keyword">from</span> <span class="string">&#x27;isomorphic-unfetch&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Index = <span class="function"><span class="params">props</span> =&gt;</span> (</span><br><span class="line">  &lt;Layout&gt;</span><br><span class="line">    &lt;h1&gt;Batman TV Shows&lt;/h1&gt;</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &#123;</span><br><span class="line">        props.shows.map(<span class="function"><span class="params">show</span> =&gt;</span> (</span><br><span class="line">          &lt;li key=&#123;show.id&#125;&gt;</span><br><span class="line">            &lt;Link href=<span class="string">&quot;/p/[id]&quot;</span> <span class="keyword">as</span>=&#123;<span class="string">`/p/<span class="subst">$&#123;show.id&#125;</span>`</span>&#125;&gt;</span><br><span class="line">              &lt;a&gt;&#123;show.name&#125;&lt;/a&gt;</span><br><span class="line">            &lt;/Link&gt;</span><br><span class="line">          &lt;/li&gt;</span><br><span class="line">        ))</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  &lt;/Layout&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">Index.getInitialProps = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> fetch(<span class="string">&#x27;https://api.tvmaze.com/search/shows?q=batman&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> res.json();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Show data fetched. Count: <span class="subst">$&#123;data.length&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    shows: data.map(<span class="function"><span class="params">entry</span> =&gt;</span> entry.show)</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Index;</span><br></pre></td></tr></table></figure></li><li>我们着重分析下面这部分： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Index.getInitialProps = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> fetch(<span class="string">&#x27;https://api.tvmaze.com/search/shows?q=batman&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> res.json();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Show data fetched. Count: <span class="subst">$&#123;data.length&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    shows: data.map(<span class="function"><span class="params">entry</span> =&gt;</span> entry.show)</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>这是一个静态异步函数，可以添加到程序的任何页面中，使用此函数，我们就可以获取数据并作为 props 传递给我们的页面</li><li>以下便是我们的抓取结果，数据被抓取后，将会作为 props 的 ‘show’ 属性传递我们的页面中<br>  <img src="https://s2.ax1x.com/2020/02/17/3PEsaT.png" class="lazyload" data-srcset="https://s2.ax1x.com/2020/02/17/3PEsaT.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></li></ul></li><li>注意，我们之前有一行用于打印信息的代码： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">`Show data fetched. Count: <span class="subst">$&#123;data.length&#125;</span>`</span>);</span><br></pre></td></tr></table></figure><ul><li>那么到底是在服务器端输出呢，还是在浏览器端的控制台输出呢，现在刷新一下浏览器，会发现之后服务端的控制台显示<br>  <img src="https://s2.ax1x.com/2020/02/17/3PeiKs.png" class="lazyload" data-srcset="https://s2.ax1x.com/2020/02/17/3PeiKs.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></li><li>在这种情况下，消息只会在服务端输出，因为我们的页面是在服务端绘制的，所以，我们在服务端已经有了数据，没有必要在客户端再次获取这些数据</li></ul></li></ol><h3 id="实现-Post-页面"><a href="#实现-Post-页面" class="headerlink" title="实现 Post 页面"></a>实现 Post 页面</h3><ol><li>现在让我们把 TV show 的详细信息添加到 post 中：将 <code>pages/p/[id].js</code> 替换为以下内容： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/p/[id].js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">&#x27;../../components/MyLayout&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> fetch <span class="keyword">from</span> <span class="string">&#x27;isomorphic-unfetch&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Post = <span class="function"><span class="params">props</span> =&gt;</span> (</span><br><span class="line">  &lt;Layout&gt;</span><br><span class="line">    &lt;h1&gt;&#123;props.show.name&#125;&lt;/h1&gt;</span><br><span class="line">    &lt;p&gt;&#123; props.show.summary.replace(<span class="regexp">/&lt;[/]?[pb]&gt;/g</span>), <span class="string">&#x27;&#x27;</span> &#125;&lt;/p&gt;</span><br><span class="line">  &lt;/Layout&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">Post.getInitialProps = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; id &#125; = context.query;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> fetch(<span class="string">`https://api.tvmaze.com/shows/<span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">const</span> show = <span class="keyword">await</span> res.json();</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Fetched show: <span class="subst">$&#123;show.name&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; show &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Post;</span><br></pre></td></tr></table></figure><ul><li>注意该页的 <code>getInitialProps</code>：  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Post.getInitialProps = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; id &#125; = context.query;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> fetch(<span class="string">`https://api.tvmaze.com/shows/<span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">const</span> show = <span class="keyword">await</span> res.json();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Fetched show: <span class="subst">$&#123;show.name&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; show &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li>该函数的第一个参数是 <strong>context 对象</strong>，此对象包含一个 <code>query</code> 对象，我们用 <code>context.query</code> 来获取信息，即 <code>id</code> 对象，并使其在 TVMaze API 中获取电视节目数据</li></ul></li><li>在这个 <code>getInitialProps</code> 函数中，我们添加了一个 <code>console.log</code> 来打印节目的标题，现在我们看看它将打印到哪里<ul><li>打开服务器和客户端的控制台，然后启动项目，访问 3000 端口</li><li>单击第一个 Batman show 的标题</li></ul></li><li>结果是：会在客户端的控制台输出<br> <img src="https://s2.ax1x.com/2020/02/17/3PM0ER.png" class="lazyload" data-srcset="https://s2.ax1x.com/2020/02/17/3PM0ER.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="><ul><li>与之前不同的是，我们这次只能在客户端看到消息，这是因为我们通过客户端导航到了 post 页面</li><li>当我们单击链接时，由于该链接是被 Next.js 的 <code>&lt;Link&gt;</code> 组件包装过的组件，所以页面转换将在浏览器中进行，而不会想服务器发起请求</li><li>但是，如果你直接访问的是 post 页面，而不是点击链接（例如，你直接访问 <a href="http://localhost:3000/p/975">http://localhost:3000/p/975</a> ），消息会被打印在服务端，而不是客户端</li></ul></li></ol><hr><h2 id="为组件添加样式"><a href="#为组件添加样式" class="headerlink" title="为组件添加样式"></a>为组件添加样式</h2><h3 id="Introduction-5"><a href="#Introduction-5" class="headerlink" title="Introduction"></a>Introduction</h3><blockquote><p>接下来的操作都会在 <code>next-learn-demo/7-styling-components</code> 中进行，请调至指定目录</p></blockquote><ol><li>对于 React，我们可以使用许多不同的技术来设置样式，这些技术可以分为两大类：<ul><li>传统的基于 CSS 文件的样式设计（包括 SASS、PostCSS 等）</li><li><a href="https://github.com/MicheleBertoli/css-in-js">CSS in JS</a></li></ul></li><li>传统的基于 CSS 文件的样式设计（尤其是 SSR）需要考虑一堆的实际问题，因此我们在为 Mext.js 设置样式时避免使用这种方法，相反，我们会在 JS 中使用 CSS，你可以使用它来设置某单个组件的样式，而不是导入 CSS 文件</li><li>为此，我们需要认识一个新的框架：<a href="https://github.com/zeit/styled-jsx">styled-jsx</a>，这是Next.js 预装了一个 CSS in JS 框架，它允许你为组件编写熟悉的 CSS 规则，这些 CSS 规则对组件以外的任何内容（当然也包括子组件）都没有影响，也就是说，你的 CSS 规则是有作用域的</li></ol><h3 id="安装设置-2"><a href="#安装设置-2" class="headerlink" title="安装设置"></a>安装设置</h3><ol><li>进入 <code>next-learn-demo/7-styling-components</code></li><li>输入 <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure></li><li>启动项目，访问应用</li></ol><h3 id="设置主页的样式"><a href="#设置主页的样式" class="headerlink" title="设置主页的样式"></a>设置主页的样式</h3><ol><li>现在我们在主页中添加一些样式，进入 <code>pages/index.js</code>： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">&#x27;../components/MyLayout&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> Link <span class="keyword">from</span> <span class="string">&#x27;next/link&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPosts</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="string">&#x27;hello-nextjs&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;Hello Next.js&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="string">&#x27;learn-nextjs&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;Learn Next.js is awesome&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="string">&#x27;deploy-nextjs&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;Deploy apps with ZEIT&#x27;</span> &#125;</span><br><span class="line">  ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Blog</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Lauout&gt;</span><br><span class="line">      &lt;h1&gt;My Blog&lt;/h1&gt;</span><br><span class="line">      &lt;ul&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          getPosts().map(<span class="function"><span class="params">post</span> =&gt;</span> (</span><br><span class="line">            &lt;li&gt;</span><br><span class="line">              &lt;Link href=<span class="string">&quot;/p/[id]&quot;</span> <span class="keyword">as</span>=&#123;<span class="string">`/p/<span class="subst">$&#123;post.id&#125;</span>`</span>&#125;&gt;</span><br><span class="line">                &lt;a&gt;&#123;post.title&#125;&lt;/a&gt;</span><br><span class="line">              &lt;/Link&gt;</span><br><span class="line">            &lt;/li&gt;</span><br><span class="line">          ))</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">      &lt;style jsx&gt;&#123;<span class="string">`</span></span><br><span class="line"><span class="string">        h1, a &#123;</span></span><br><span class="line"><span class="string">          font-family: &#x27;Arial&#x27;;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ul &#123;</span></span><br><span class="line"><span class="string">          padding: 0</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        li &#123;</span></span><br><span class="line"><span class="string">          list-style: none;</span></span><br><span class="line"><span class="string">          margin: 5px, 0;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        a &#123;</span></span><br><span class="line"><span class="string">          text-decoration: none;</span></span><br><span class="line"><span class="string">          color: red;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        a:hover &#123;</span></span><br><span class="line"><span class="string">          opacity: 0.6;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      `</span>&#125;&lt;/style&gt;</span><br><span class="line">    &lt;/Lauout&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>那个 <code>&lt;style jsx&gt;</code> 元素，就是我们编写 CSS 规则的地方</li><li>现在可以启动项目，查看结果<br>  <img src="https://s2.ax1x.com/2020/02/17/3ik94e.png" class="lazyload" data-srcset="https://s2.ax1x.com/2020/02/17/3ik94e.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></li></ul></li><li>上面的代码中，我们没有直接在 <code>&lt;style&gt;</code> 标签内编写样式代码，而是写在模板字符串（<code>&#123;``&#125;</code>）里面的，Next.js 默认支持 babel 语法，而 <code>styled-jsx</code> 可以看做 babel 的一个插件，它将解析所有 CSS 并将其应用于构建工程</li></ol><h3 id="CSS样式和嵌套组件"><a href="#CSS样式和嵌套组件" class="headerlink" title="CSS样式和嵌套组件"></a>CSS样式和嵌套组件</h3><ol><li>现在我们将会对主页做一些更改，我们将会像这样隔离 Link 组件： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">&#x27;../components/MyLayout&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> Link <span class="keyword">from</span> <span class="string">&#x27;next/link&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPosts</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="string">&#x27;hello-nextjs&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;Hello Next.js&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="string">&#x27;learn-nextjs&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;Learn Next.js is awesome&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="string">&#x27;deploy-nextjs&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;Deploy apps with ZEIT&#x27;</span> &#125;</span><br><span class="line">  ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PostLink = <span class="function">(<span class="params">&#123; post &#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;li&gt;</span><br><span class="line">    &lt;Link href=<span class="string">&quot;/p/[id]&quot;</span> <span class="keyword">as</span>=&#123;<span class="string">`/p/<span class="subst">$&#123;post.id&#125;</span>`</span>&#125;&gt;</span><br><span class="line">      &lt;a&gt;&#123;post.title&#125;&lt;/a&gt;</span><br><span class="line">    &lt;/Link&gt;</span><br><span class="line">  &lt;/li&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Blog</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Layout&gt;</span><br><span class="line">      &lt;h1&gt;My Blog&lt;/h1&gt;</span><br><span class="line">      &lt;ul&gt;</span><br><span class="line">        &#123;getPosts().map(<span class="function"><span class="params">post</span> =&gt;</span> (</span><br><span class="line">          &lt;PostLink key=&#123;post.id&#125; post=&#123;post&#125; /&gt;</span><br><span class="line">        ))&#125;</span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">      &lt;style jsx&gt;&#123;<span class="string">`</span></span><br><span class="line"><span class="string">        h1, a &#123;</span></span><br><span class="line"><span class="string">          font-family: &#x27;Arial&#x27;;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ul &#123;</span></span><br><span class="line"><span class="string">          padding: 0;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        li &#123;</span></span><br><span class="line"><span class="string">          list-style: none;</span></span><br><span class="line"><span class="string">          margin: 5px 0;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        a &#123;</span></span><br><span class="line"><span class="string">          text-decoration: none;</span></span><br><span class="line"><span class="string">          color: blue;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        a:hover &#123;</span></span><br><span class="line"><span class="string">          opacity: 0.6;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      `</span>&#125;&lt;/style&gt;</span><br><span class="line">    &lt;/Layout&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>运行后发现：h1 的样式还在，但是链接已经失效了，如下：<br>  <img src="https://s2.ax1x.com/2020/02/18/3is3bd.png" class="lazyload" data-srcset="https://s2.ax1x.com/2020/02/18/3is3bd.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></li></ul></li><li>上述结果显示：CSS 样式规则对子组件中的元素没有影响，<code>styled-jsx</code> 这个特性可以帮助你管理大型的应用程序的样式，在这种情况下，我们需要直接设置子组件的样式，在我们的示例中，我们需要对 Link 组件执行以下操作： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PostLink = <span class="function">(<span class="params">&#123; post &#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;li&gt;</span><br><span class="line">    &lt;Link href=<span class="string">&quot;/p/[id]&quot;</span> <span class="keyword">as</span>=&#123;<span class="string">`/p/<span class="subst">$&#123;post.id&#125;</span>`</span>&#125;&gt;</span><br><span class="line">      &lt;a&gt;&#123;post.title&#125;&lt;/a&gt;</span><br><span class="line">    &lt;/Link&gt;</span><br><span class="line">    &lt;style jsx&gt;&#123;<span class="string">`</span></span><br><span class="line"><span class="string">      li &#123;</span></span><br><span class="line"><span class="string">        list-style: none;</span></span><br><span class="line"><span class="string">        margin: 5px 0;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      a &#123;</span></span><br><span class="line"><span class="string">        text-decoration: none;</span></span><br><span class="line"><span class="string">        color: blue;</span></span><br><span class="line"><span class="string">        font-family: &#x27;Arial&#x27;;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      a:hover &#123;</span></span><br><span class="line"><span class="string">        opacity: 0.6;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    `</span>&#125;&lt;/style&gt;</span><br><span class="line">  &lt;/li&gt;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul><li>拓展了解：<a href="https://github.com/zeit/styled-jsx#one-off-global-selectors">全局选择器</a></li></ul></li></ol><h3 id="全局样式"><a href="#全局样式" class="headerlink" title="全局样式"></a>全局样式</h3><ol><li>有时我们确实需要更改子组件内部的样式，尤其是在使用支持 React 的 markdown 时<ul><li>我们需要安装 <code>react-markdown</code>  <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save react-markdown</span><br></pre></td></tr></table></figure></li></ul></li><li>下面就是全局样式派上用场的地方，现在就来试试利用 <code>styled-jsx</code> 添加一些全局样式，打开 <code>pages/p/[id].js</code>： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;next/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> Markdown <span class="keyword">from</span> <span class="string">&#x27;react-markdown&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">&#x27;../../components/MyLayout&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> router = useRouter();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Layout&gt;</span><br><span class="line">      &lt;h1&gt;&#123;router.query.id&#125;&lt;/h1&gt;</span><br><span class="line">      &lt;div className=<span class="string">&quot;markdown&quot;</span>&gt;</span><br><span class="line">        &lt;Markdown</span><br><span class="line">          source=&#123;<span class="string">`</span></span><br><span class="line"><span class="string">This is our blog post.</span></span><br><span class="line"><span class="string">Yes. We can have a [link](/link).</span></span><br><span class="line"><span class="string">And we can have a title as well.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### This is a titlr.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">And here&#x27;s the content.</span></span><br><span class="line"><span class="string">          `</span>&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;style jsx <span class="built_in">global</span>&gt;&#123;<span class="string">`</span></span><br><span class="line"><span class="string">        .markdown &#123;</span></span><br><span class="line"><span class="string">          font-family: &#x27;Arial&#x27;;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        .markdown a &#123;</span></span><br><span class="line"><span class="string">          text-decoration: none;</span></span><br><span class="line"><span class="string">          color: red;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        .markdown a:hover &#123;</span></span><br><span class="line"><span class="string">          opacity: 0.6;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        .markdown h3 &#123;</span></span><br><span class="line"><span class="string">          margin: 0;</span></span><br><span class="line"><span class="string">          padding: 0;</span></span><br><span class="line"><span class="string">          text-transform: uppercase;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      `</span>&#125;&lt;/style&gt;</span><br><span class="line">    &lt;/Layout&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>注意，<strong>markdown 语法部分的缩进不可修改！！！</strong></li><li>我们定义的 style 作用于整个 <code>&lt;div&gt;</code> 标签部分，也就是作用于全局，虽然这样很方便，但是还是建议写带有作用域的样式</li><li>尽管如此，这依然是一个比普通样式标签更好的解决方案，使用 styled-jsx 时，所有必要的特定于浏览器厂商前缀和 CSS 校验都通过了一个 Babel 插件完成了，这并不会导致额外的开销</li></ul></li></ol><hr><h2 id="部署-Next-js-应用程序"><a href="#部署-Next-js-应用程序" class="headerlink" title="部署 Next.js 应用程序"></a>部署 Next.js 应用程序</h2><h3 id="Introduction-6"><a href="#Introduction-6" class="headerlink" title="Introduction"></a>Introduction</h3><blockquote><p>接下来的操作都会在 <code>next-learn-demo/8-deploying</code> 中进行，请调至指定目录</p></blockquote><ol><li><a href="https://zeit.co/home">ZEIT Now</a> 是将应用程序部署到生产环境的最简单和可扩展的方法，但是，你可以部署 Next.js 应用程序，而且它相对来讲比较简单</li><li>现在我们将部署 Next.js 应用程序</li><li>进入 <code>next-learn-demo/8-deploying</code>，输入命令： <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure></li></ol><h3 id="部署到-ZEIT-Now"><a href="#部署到-ZEIT-Now" class="headerlink" title="部署到 ZEIT Now"></a>部署到 ZEIT Now</h3><ol><li>我们来看一下 <code>package.json</code> 文件的 <code>script</code> 配置段： <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">   &quot;dev&quot;: &quot;next&quot;,</span><br><span class="line">   &quot;build&quot;: &quot;next build&quot;,</span><br><span class="line">   &quot;start&quot;: &quot;next start&quot;</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure></li><li>首先，我们需要为生产环境编译我们的 Next.js 应用程序，它将生成一组优化的用于生产环境的代码： <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure></li><li>然后，你需要启动 Next.js 应用程序并监听某个端口，此服务器将执行服务器端渲染并返回静态页面（使用上述命令编译） <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run <span class="built_in">start</span></span><br></pre></td></tr></table></figure><ul><li>现在可以查看效果：<a href="http://localhost:3000/">http://localhost:3000</a></li></ul></li></ol><h3 id="运行两个实例"><a href="#运行两个实例" class="headerlink" title="运行两个实例"></a>运行两个实例</h3><ol><li>现在我们将为我们的应用程序启动两个实例，通常这样是为了横向扩展我们的应用程序</li><li>首先，将 <code>package.json</code> 中的 <code>script</code> 配置端替换为以下的内容： <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">  &quot;dev&quot;: &quot;next&quot;,</span><br><span class="line">  &quot;build&quot;: &quot;next build&quot;,</span><br><span class="line">  &quot;start&quot;: &quot;next start -p %PORT%&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>我们更改了 <code>start</code> 脚本，它卸载接受一个代表端口号的参数来启动应用程序</li><li>注意，<code>%PORT%</code> 是对于 Windows 来说的，Linux 对应的是 <code>$PORT</code></li></ul></li><li>现在构建我们的应用程序： <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure></li><li>现在我们需要安装一个新的包，即：<code>cross-env</code>，我们在全局环境下安装： <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install cross-env -g</span><br></pre></td></tr></table></figure></li><li>同时打开两个终端，分别在终端中输入： <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cross-env PORT=<span class="number">8000</span> npm <span class="built_in">start</span></span><br><span class="line">cross-env PORT=<span class="number">9000</span> npm <span class="built_in">start</span></span><br></pre></td></tr></table></figure><ul><li>在 Linux 上，则直接打开两个命令行终端，并分别在每个命令行终端上运行：  <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PORT=<span class="number">8000</span> npm <span class="built_in">start</span></span><br><span class="line">PORT=<span class="number">9000</span> npm <span class="built_in">start</span></span><br></pre></td></tr></table></figure></li></ul></li><li>现在，在浏览器分别查看：<a href="http://localhost:8000/">http://localhost:8000</a> 和 <a href="http://localhost:9000/">http://localhost:9000</a></li><li>可以得到的结果是，你只需要对应用程序构建一次。然后就可以在任意多个端口上启动它</li></ol><hr><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><blockquote><p>求进之路，持之谦卑</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
